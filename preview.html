<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>文件预览插件</title>
	<link rel="stylesheet" href="static/common/css/main.css">
	<link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.13/lib/theme-chalk/index.css">
	<link rel="stylesheet" href="static/common/css/audio.css">
	<link rel="stylesheet" href="static/luckysheet/css/pluginsCss.css">
	<link rel="stylesheet" href="static/luckysheet/css/plugins.css">
	<link rel="stylesheet" href="static/luckysheet/css/luckysheet.css">
	<link rel="stylesheet" href="static/luckysheet/css/iconfont.css">
	<link rel="stylesheet" href="static/pptxjs/css/pptxjs.css">
	<link rel="stylesheet" href="static/pptxjs/css/nv.d3.min.css">
	<link rel="stylesheet" href="static/viewer/viewer.css">
	<link rel="stylesheet" href="static/prism/prism.css">
</head>
<body>
<div id="el-app">
	<div id="container">
	</div>
</div>

<!-- built files will be auto injected -->

<script type="text/javascript" src="static/jquery-2.0.3.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/vue@2.7.14/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui@2.15.13/lib/index.js"></script>
<script type="text/javascript" src="static/jPreview.js?v2"></script>
<script>
	var app = new Vue({
		delimiters: ['${', '}'],
		el: '#el-app',
		data(){
			return {
				loading: true,
			};
		},
		created(){
			// 简单的来源验证
			if (!this.checkAccess()) {
				document.getElementById('container').innerHTML = 
					'<div style="text-align:center;padding:100px;color:#999;font-size:16px;">⚠️ 请通过正常途径访问</div>';
				return;
			}

			const loading = this.$loading({
				lock: true,
				text: '资源加载中...',
				spinner: 'el-icon-loading',
				background: 'rgba(0, 0, 0, 0.9)'
			});
			// 获取url中的src/url参数和ext参数
			const urlParams = new URLSearchParams(window.location.search);
			const src = urlParams.get('src') || urlParams.get('url') || '';
			const ext = urlParams.get('ext') || '';
			const name = urlParams.get('name') || '';

			this.$nextTick(function(){
				jPreview.preview({
					container:"container",
					staticPath:"./static",
					url: src,
					ext: ext,
					name: name,
					watermarkSize: "",
					priority: 1,
					oburl: "",
				});
				loading.close();
			})
		},
		methods: {
			checkAccess() {
				const AUTH_KEY = 'pv_auth';
				const referrer = document.referrer;
				
				// 检查 referrer 是否同源
				if (referrer) {
					try {
						const refOrigin = new URL(referrer).origin;
						const curOrigin = window.location.origin;
						if (refOrigin === curOrigin) {
							// 同源访问，设置 sessionStorage 标记（支持刷新）
							sessionStorage.setItem(AUTH_KEY, Date.now().toString());
							return true;
						}
					} catch (e) {}
				}
				
				// 检查 sessionStorage 标记（允许刷新页面）
				const authTime = sessionStorage.getItem(AUTH_KEY);
				if (authTime) {
				// 标记有效期 2 小时
				if (Date.now() - parseInt(authTime) < 2 * 60 * 60 * 1000) {
						return true;
					}
					sessionStorage.removeItem(AUTH_KEY);
				}
				
				return false;
			}
		}
	})
	</script>
</body>
</html>
